{% extends 'core/base_main.html' %}
{% load static %}

{% block title %}Create new post â€¢ Instagram{% endblock %}

{% block content %}
<div class="create-post-container">
    <div class="create-post-modal">
        <div class="modal-header">
            <h2>Create new post</h2>
            <button class="close-btn" onclick="window.history.back()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <line fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x1="18" x2="6" y1="6" y2="18"/>
                    <line fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x1="6" x2="18" y1="6" y2="18"/>
                </svg>
            </button>
        </div>

        <form method="post" enctype="multipart/form-data" class="create-post-form" id="createPostForm" action="{% url 'core:create_post' %}">
            {% csrf_token %}
            
            <!-- Improved upload section with better responsive design and clearer workflow -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-content">
                        <div class="upload-icon">
                            <svg width="96" height="77" viewBox="0 0 96 77" fill="currentColor">
                                <path d="M43.5 0h9v77h-9V0z"/>
                                <path d="M0 33.5h96v9H0v-9z"/>
                            </svg>
                        </div>
                        <h3>Drag photos and videos here</h3>
                        <div class="upload-buttons">
                            <button type="button" class="select-btn" onclick="document.getElementById('mediaInput').click()">
                                Select from computer
                            </button>
                        </div>
                    </div>
                    <input type="file" id="mediaInput" name="media" accept="image/*,video/*" style="display: none;">
                    
                    <!-- Added better upload progress with clearer visual feedback -->
                    <div class="upload-progress" id="uploadProgress" style="display: none;">
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="progress-text">
                                <span id="progressPercent">0%</span>
                                <span id="progressStatus">Uploading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Improved preview section with better sizing -->
                <div class="preview-section" id="previewSection" style="display: none;">
                    <div class="media-preview-container">
                        <img id="imagePreview" src="{% static 'images/placeholder.png' %}" alt="Preview" class="media-preview" style="display: none;">
                        <video id="videoPreview" class="media-preview" style="display: none;" controls>
                            <source src="" type="video/mp4">
                        </video>
                    </div>
                </div>
            </div>

            <!-- Redesigned post details section with better layout -->
            <div class="post-details" id="postDetails" style="display: none;">
                <div class="post-preview-container">
                    <div class="final-preview-wrapper">
                        <img id="finalImagePreview" src="{% static 'images/placeholder.png' %}" alt="Post preview" class="final-preview" style="display: none;">
                        <video id="finalVideoPreview" class="final-preview" style="display: none;" controls>
                            <source src="" type="video/mp4">
                        </video>
                    </div>
                </div>
                
                <div class="post-form-container">
                    <div class="user-info">
                        <img src="{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}/static/images/default-avatar.jpg{% endif %}" 
                             alt="{{ user.username }}" class="user-avatar">
                        <span class="username">{{ user.username }}</span>
                    </div>
                    
                    <div class="caption-section">
                        <textarea name="caption" placeholder="Write a caption..." class="caption-input" maxlength="2200" id="captionTextarea"></textarea>
                        <div class="caption-counter">
                            <span id="captionCount">0</span>/2,200
                        </div>
                    </div>
                    
                    <div class="accessibility-section">
                        <div class="section-header">
                            <span>Accessibility</span>
                        </div>
                        <p class="section-description">
                            Alt text describes your photos for people with visual impairments.
                        </p>
                        <div class="alt-text-container">
                            <div class="alt-preview-wrapper">
                                <img id="altImagePreview" src="{% static 'images/placeholder.png' %}" alt="Alt text preview" class="alt-preview" style="display: none;">
                                <video id="altVideoPreview" class="alt-preview" style="display: none;">
                                    <source src="" type="video/mp4">
                                </video>
                            </div>
                            <input type="text" name="alt_text" placeholder="Write alt text..." class="alt-input">
                        </div>
                    </div>
                    
                    <div class="advanced-settings">
                        <div class="setting-item">
                            <span>Hide like and view counts on this post</span>
                            <label class="toggle">
                                <input type="checkbox" name="hide_counts">
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-item">
                            <span>Turn off commenting</span>
                            <label class="toggle">
                                <input type="checkbox" name="disable_comments">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fixed modal footer with proper button positioning and visibility -->
            <div class="modal-footer" id="modalFooter">
                <div class="footer-buttons">
                    <button type="button" class="back-btn" id="backBtn" style="display: none;">Back</button>
                    <button type="button" class="next-btn" id="nextBtn" style="display: none;">Next</button>
                    <button type="submit" class="share-btn" id="shareBtn" style="display: none;">Share</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Global variables for accessibility
    let selectedFile = null;
    let isVideo = false;

    // Define DOM elements in global scope for accessibility
    let previewSection, postDetails, nextBtn, backBtn, shareBtn;

    // Define functions in global scope to be accessible by onclick attributes
    function showDetails() {
        if (!selectedFile) {
            alert('Please select an image or video');
            console.log("Next button clicked: No file selected");
            return;
        }
        previewSection.style.display = 'none';
        postDetails.style.display = 'flex';
        nextBtn.style.display = 'none';
        backBtn.style.display = 'block';
        shareBtn.style.display = 'block';
        shareBtn.disabled = false;
        console.log("Showing details section, shareBtn disabled:", shareBtn.disabled);
    }

    function goBack() {
        postDetails.style.display = 'none';
        previewSection.style.display = 'block';
        backBtn.style.display = 'none';
        shareBtn.style.display = 'none';
        nextBtn.style.display = 'block';
        console.log("Returning to preview section");
    }

    document.addEventListener("DOMContentLoaded", () => {
        console.log("create_post.html extra_js loaded");

        // DOM elements
        const mediaInput = document.getElementById('mediaInput');
        const uploadArea = document.getElementById('uploadArea');
        const uploadSection = document.getElementById('uploadSection');
        previewSection = document.getElementById('previewSection');
        postDetails = document.getElementById('postDetails');
        const imagePreview = document.getElementById('imagePreview');
        const videoPreview = document.getElementById('videoPreview');
        const finalImagePreview = document.getElementById('finalImagePreview');
        const finalVideoPreview = document.getElementById('finalVideoPreview');
        const altImagePreview = document.getElementById('altImagePreview');
        const altVideoPreview = document.getElementById('altVideoPreview');
        nextBtn = document.getElementById('nextBtn');
        backBtn = document.getElementById('backBtn');
        shareBtn = document.getElementById('shareBtn');
        const captionTextarea = document.getElementById('captionTextarea');
        const captionCount = document.getElementById('captionCount');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressFill = document.getElementById('progressFill');
        const progressPercent = document.getElementById('progressPercent');

        // Debug: Verify elements
        console.log("DOM elements:", {
            mediaInput: !!mediaInput,
            uploadArea: !!uploadArea,
            uploadSection: !!uploadSection,
            previewSection: !!previewSection,
            postDetails: !!postDetails,
            imagePreview: !!imagePreview,
            videoPreview: !!videoPreview,
            finalImagePreview: !!finalImagePreview,
            finalVideoPreview: !!finalVideoPreview,
            altImagePreview: !!altImagePreview,
            altVideoPreview: !!altVideoPreview,
            nextBtn: !!nextBtn,
            backBtn: !!backBtn,
            shareBtn: !!shareBtn,
            captionTextarea: !!captionTextarea,
            captionCount: !!captionCount,
            uploadProgress: !!uploadProgress,
            progressFill: !!progressFill,
            progressPercent: !!progressPercent
        });

        // Drag and drop handlers
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
            console.log("Drag over upload area");
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            console.log("Drag leave upload area");
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                console.log("File dropped:", files[0].name);
                handleMediaSelect(files[0]);
            }
        });

        mediaInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                console.log("File selected:", e.target.files[0].name);
                handleMediaSelect(e.target.files[0]);
            }
        });

        function handleMediaSelect(file) {
            selectedFile = file;
            
            const validImageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            const validVideoTypes = ['video/mp4', 'video/webm', 'video/ogg', 'video/mov', 'video/avi'];
            
            isVideo = validVideoTypes.includes(file.type);
            const isImage = validImageTypes.includes(file.type);
            
            if (!isImage && !isVideo) {
                alert('Please select a valid image (JPG, PNG, GIF, WebP) or video (MP4, WebM, OGG, MOV, AVI) file');
                console.log("Invalid file type:", file.type);
                selectedFile = null;
                return;
            }
            
            const maxSize = isVideo ? 100 * 1024 * 1024 : 10 * 1024 * 1024;
            if (file.size > maxSize) {
                alert(`File too large. Maximum size is ${isVideo ? '100MB' : '10MB'}`);
                console.log("File too large:", file.size, "Max:", maxSize);
                selectedFile = null;
                return;
            }
            
            showUploadProgress();
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const result = e.target.result;
                
                if (isVideo) {
                    videoPreview.src = result;
                    finalVideoPreview.src = result;
                    altVideoPreview.src = result;
                    videoPreview.style.display = 'block';
                    imagePreview.style.display = 'none';
                    finalVideoPreview.style.display = 'block';
                    finalImagePreview.style.display = 'none';
                    altVideoPreview.style.display = 'block';
                    altImagePreview.style.display = 'none';
                    console.log("Video preview set");
                } else {
                    imagePreview.src = result;
                    finalImagePreview.src = result;
                    altImagePreview.src = result;
                    imagePreview.style.display = 'block';
                    videoPreview.style.display = 'none';
                    finalImagePreview.style.display = 'block';
                    finalVideoPreview.style.display = 'none';
                    altImagePreview.style.display = 'block';
                    altVideoPreview.style.display = 'none';
                    console.log("Image preview set");
                }
                
                simulateUploadProgress(() => {
                    uploadSection.style.display = 'none';
                    previewSection.style.display = 'block';
                    nextBtn.style.display = 'block';
                    console.log("Upload progress complete, showing preview section");
                });
            };
            reader.readAsDataURL(file);
        }

        function showUploadProgress() {
            uploadProgress.style.display = 'block';
            progressFill.style.width = '0%';
            progressPercent.textContent = '0%';
            console.log("Showing upload progress");
        }

        function simulateUploadProgress(callback) {
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    setTimeout(callback, 500);
                    console.log("Upload progress simulation complete");
                }
                progressFill.style.width = progress + '%';
                progressPercent.textContent = Math.round(progress) + '%';
            }, 100);
        }

        if (captionTextarea) {
            captionTextarea.addEventListener('input', () => {
                captionCount.textContent = captionTextarea.value.length;
                console.log("Caption updated, count:", captionTextarea.value.length);
            });
        }

        // Bind Next and Back buttons programmatically
        nextBtn.addEventListener('click', showDetails);
        backBtn.addEventListener('click', goBack);

        const form = document.getElementById('createPostForm');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            console.log("Form submission started");

            if (!selectedFile) {
                alert('Please select an image or video');
                console.log("Form submission blocked - no file selected");
                return;
            }

            const formData = new FormData(form);
            formData.append('media', selectedFile); // Ensure correct field name for views.py

            console.log("Form data:", Array.from(formData.entries()));

            shareBtn.textContent = 'Sharing...';
            shareBtn.disabled = true;
            console.log("Share button disabled, showing loading state");

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => {
                    console.log("Fetch response:", {
                        status: response.status,
                        statusText: response.statusText
                    });
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`HTTP ${response.status}: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("JSON response:", data);
                    if (data.success) {
                        console.log("Post created successfully, redirecting to:", data.redirect);
                        window.location.href = data.redirect;
                    } else {
                        alert(data.error || 'Failed to create post');
                        console.log("Post creation failed:", data.error);
                        shareBtn.textContent = 'Share';
                        shareBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error("Fetch error:", error);
                    alert('Upload failed: ' + error.message);
                    shareBtn.textContent = 'Share';
                    shareBtn.disabled = false;
                    console.log("Share button re-enabled after error");
                });
        });

        // Debug: Verify share button click
        shareBtn.addEventListener('click', () => {
            console.log("Share button clicked, disabled state:", shareBtn.disabled);
            if (!shareBtn.disabled) {
                form.dispatchEvent(new Event('submit')); // Programmatically trigger form submission
            }
        });
    });
</script>
{% endblock %}